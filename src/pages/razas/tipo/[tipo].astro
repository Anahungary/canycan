---
// src/pages/razas/tipo/[tipo].astro - Página dinámica para filtrar razas por tipo (CORREGIDA)
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Container from '../../../components/ui/Container.astro';
import BreedCard from '../../../components/features/breeds-comparison/BreedCard.astro';
import Card from '../../../components/ui/Card.astro';
import Button from '../../../components/ui/Button.astro';

// ✅ DEFINIR TIPOS PARA MEJOR TIPADO
interface TypeInfo {
  slug: string;
  name: string;
  type: 'dog' | 'cat';
}

interface BreedData {
  id: string;
  name: string;
  image: string;
  size: 'small' | 'medium' | 'large';
  energyLevel: 1 | 2 | 3 | 4 | 5;
  friendliness: 1 | 2 | 3 | 4 | 5;
  grooming: 1 | 2 | 3 | 4 | 5;
  training: 1 | 2 | 3 | 4 | 5;
  type: 'dog' | 'cat';
  goodWith: ('children' | 'dogs' | 'cats' | 'seniors' | 'apartments')[];
  hypoallergenic: boolean;
  featured?: boolean;
}

// Generar rutas dinámicas para tipos de mascota
export function getStaticPaths() {
  const types: TypeInfo[] = [
    { slug: 'perros', name: 'Perros', type: 'dog' },
    { slug: 'gatos', name: 'Gatos', type: 'cat' }
  ];
  
  // ✅ DATOS DE RAZAS CON TIPADO CORRECTO
  const allBreeds: BreedData[] = [
    // Perros
    {
      id: 'labrador-retriever',
      name: 'Labrador Retriever',
      image: '/images/breeds/labrador-retriever.jpg',
      size: 'large',
      energyLevel: 4,
      friendliness: 5,
      grooming: 2,
      training: 5,
      type: 'dog',
      goodWith: ['children', 'dogs', 'cats'],
      hypoallergenic: false,
      featured: true
    },
    {
      id: 'french-bulldog',
      name: 'Bulldog Francés',
      image: '/images/breeds/french-bulldog.jpg',
      size: 'small',
      energyLevel: 3,
      friendliness: 4,
      grooming: 2,
      training: 3,
      type: 'dog',
      goodWith: ['children', 'seniors', 'apartments'],
      hypoallergenic: false
    },
    {
      id: 'golden-retriever',
      name: 'Golden Retriever',
      image: '/images/breeds/golden-retriever.jpg',
      size: 'large',
      energyLevel: 4,
      friendliness: 5,
      grooming: 3,
      training: 5,
      type: 'dog',
      goodWith: ['children', 'dogs', 'cats'],
      hypoallergenic: false,
      featured: true
    },
    {
      id: 'german-shepherd',
      name: 'Pastor Alemán',
      image: '/images/breeds/german-shepherd.jpg',
      size: 'large',
      energyLevel: 5,
      friendliness: 4,
      grooming: 3,
      training: 5,
      type: 'dog',
      goodWith: ['children'],
      hypoallergenic: false
    },
    {
      id: 'beagle',
      name: 'Beagle',
      image: '/images/breeds/beagle.jpg',
      size: 'medium',
      energyLevel: 4,
      friendliness: 5,
      grooming: 2,
      training: 3,
      type: 'dog',
      goodWith: ['children', 'dogs'],
      hypoallergenic: false
    },
    {
      id: 'poodle',
      name: 'Poodle',
      image: '/images/breeds/poodle.jpg',
      size: 'medium',
      energyLevel: 4,
      friendliness: 5,
      grooming: 5,
      training: 5,
      type: 'dog',
      goodWith: ['children', 'seniors'],
      hypoallergenic: true
    },
    
    // Gatos
    {
      id: 'maine-coon',
      name: 'Maine Coon',
      image: '/images/breeds/maine-coon.jpg',
      size: 'large',
      energyLevel: 3,
      friendliness: 4,
      grooming: 4,
      training: 3,
      type: 'cat',
      goodWith: ['children', 'dogs'],
      hypoallergenic: false,
      featured: true
    },
    {
      id: 'siamese',
      name: 'Siamés',
      image: '/images/breeds/siamese.jpg',
      size: 'medium',
      energyLevel: 4,
      friendliness: 3,
      grooming: 1,
      training: 4,
      type: 'cat',
      goodWith: ['apartments'],
      hypoallergenic: true
    },
    {
      id: 'bengal',
      name: 'Bengalí',
      image: '/images/breeds/bengal.jpg',
      size: 'medium',
      energyLevel: 5,
      friendliness: 3,
      grooming: 2,
      training: 4,
      type: 'cat',
      goodWith: [],
      hypoallergenic: false
    },
    {
      id: 'persian',
      name: 'Persa',
      image: '/images/breeds/persian.jpg',
      size: 'medium',
      energyLevel: 2,
      friendliness: 3,
      grooming: 5,
      training: 2,
      type: 'cat',
      goodWith: ['seniors', 'apartments'],
      hypoallergenic: false
    },
    {
      id: 'ragdoll',
      name: 'Ragdoll',
      image: '/images/breeds/ragdoll.jpg',
      size: 'large',
      energyLevel: 2,
      friendliness: 5,
      grooming: 3,
      training: 3,
      type: 'cat',
      goodWith: ['children', 'seniors', 'apartments'],
      hypoallergenic: false,
      featured: true
    },
    {
      id: 'sphynx',
      name: 'Sphynx',
      image: '/images/breeds/sphynx.jpg',
      size: 'medium',
      energyLevel: 3,
      friendliness: 4,
      grooming: 2,
      training: 4,
      type: 'cat',
      goodWith: ['apartments'],
      hypoallergenic: true
    }
  ];
  
  return types.map(typeInfo => {
    // Filtrar razas por tipo
    const filteredBreeds = allBreeds.filter(breed => 
      breed.type === typeInfo.type
    );
    
    return {
      params: { tipo: typeInfo.slug },
      props: { 
        typeInfo,
        breeds: filteredBreeds
      }
    };
  });
}

// ✅ DEFINIR TIPOS DE LAS PROPS
interface Props {
  typeInfo: TypeInfo;
  breeds: BreedData[];
}

const { typeInfo, breeds } = Astro.props as Props;

// ✅ DEFINIR TIPO PARA typeContent CON ÍNDICE DE CADENA
interface TypeContent {
  title: string;
  description: string;
  intro: string;
  featuredTitle: string;
  sizeSections: Array<{
    title: string;
    description: string;
    showMore: string;
  }>;
}

interface TypeContentMap {
  [key: string]: TypeContent;
  dog: TypeContent;
  cat: TypeContent;
}

// Secciones de contenido específicas por tipo
const typeContent: TypeContentMap = {
  dog: {
    title: 'Razas de Perros',
    description: 'Descubre información detallada sobre las diferentes razas de perros, sus características, temperamento y necesidades específicas.',
    intro: 'Los perros son conocidos como el mejor amigo del hombre, y con más de 300 razas reconocidas, hay un perro para cada estilo de vida y preferencia. Desde pequeños compañeros de regazo hasta grandes protectores, cada raza tiene sus propias características únicas.',
    featuredTitle: 'Razas de perros populares',
    sizeSections: [
      {
        title: 'Razas pequeñas',
        description: 'Ideales para apartamentos y espacios reducidos',
        showMore: '/razas/tamano/pequeno'
      },
      {
        title: 'Razas medianas',
        description: 'Equilibrio perfecto entre tamaño y adaptabilidad',
        showMore: '/razas/tamano/mediano'
      },
      {
        title: 'Razas grandes',
        description: 'Perfectas para espacios amplios y familias activas',
        showMore: '/razas/tamano/grande'
      }
    ]
  },
  cat: {
    title: 'Razas de Gatos',
    description: 'Explora las distintas razas de gatos, sus peculiaridades, comportamiento y cuidados específicos que necesitan.',
    intro: 'Los gatos son mascotas independientes y llenas de personalidad. Con más de 70 razas reconocidas, cada una tiene su propio conjunto de características físicas, temperamentales y necesidades de cuidado.',
    featuredTitle: 'Razas de gatos populares',
    sizeSections: [
      {
        title: 'Razas pequeñas',
        description: 'Compactos y perfectos para cualquier hogar',
        showMore: '/razas/tamano/pequeno-gato'
      },
      {
        title: 'Razas medianas',
        description: 'El tamaño estándar con gran diversidad',
        showMore: '/razas/tamano/mediano-gato'
      },
      {
        title: 'Razas grandes',
        description: 'Impresionantes felinos de mayor tamaño',
        showMore: '/razas/tamano/grande-gato'
      }
    ]
  }
};

// ✅ ACCESO TIPADO CORRECTO AL CONTENIDO
const content = typeContent[typeInfo.type];

// Filtrar razas destacadas
const featuredBreeds = breeds.filter(breed => breed.featured);

// Agrupar razas por tamaño
const smallBreeds = breeds.filter(breed => breed.size === 'small');
const mediumBreeds = breeds.filter(breed => breed.size === 'medium');
const largeBreeds = breeds.filter(breed => breed.size === 'large');
---

<BaseLayout
  title={content.title}
  description={content.description}
>
  {/* Hero */}
  <div class={`bg-gradient-to-r ${typeInfo.type === 'dog' ? 'from-[#AFC2D5] to-[#C8D6B9]' : 'from-[#F6B89E] to-[#f3f3f3]'}`}>
    <Container>
      <div class="py-12 md:py-16">
        <div class="max-w-3xl">
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">{content.title}</h1>
          <p class="text-lg text-white text-opacity-90">{content.description}</p>
        </div>
      </div>
    </Container>
  </div>
  
  <Container class="py-12">
    {/* Introducción */}
    <div class="prose max-w-none mb-12">
      <p class="text-lg">{content.intro}</p>
    </div>
    
    {/* Razas destacadas */}
    {featuredBreeds.length > 0 && (
      <div class="mb-16">
        <h2 class="text-2xl font-bold mb-6">{content.featuredTitle}</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {featuredBreeds.map(breed => (
            <!-- ✅ SPREAD OPERATOR CON BREED TIPADO CORRECTAMENTE -->
            <BreedCard 
              id={breed.id}
              name={breed.name}
              image={breed.image}
              size={breed.size}
              energyLevel={breed.energyLevel}
              friendliness={breed.friendliness}
              grooming={breed.grooming}
              training={breed.training}
              type={breed.type}
              goodWith={breed.goodWith}
              hypoallergenic={breed.hypoallergenic}
              featured={breed.featured}
            />
          ))}
        </div>
      </div>
    )}
    
    {/* Secciones por tamaño */}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
      {/* ✅ TIPADO EXPLÍCITO PARA EVITAR ERRORES */}
      {content.sizeSections.map((section: {title: string; description: string; showMore: string}, index: number) => (
        <Card variant={typeInfo.type === 'dog' ? 'default' : 'breed'} padding="md">
          <h2 class="text-xl font-bold mb-3">{section.title}</h2>
          <p class="text-gray-600 mb-4">{section.description}</p>
          
          <div class="space-y-4 mb-6">
            {/* Lista de ejemplos de razas por tamaño */}
            {(index === 0 ? smallBreeds : index === 1 ? mediumBreeds : largeBreeds)
              .slice(0, 3)
              .map(breed => (
                <a href={`/razas/${breed.id}`} class="flex items-center hover:bg-gray-50 p-2 rounded-md transition-colors">
                  <div class="w-12 h-12 rounded-full overflow-hidden flex-shrink-0">
                    <img src={breed.image} alt={breed.name} class="w-full h-full object-cover" />
                  </div>
                  <span class="ml-3 font-medium">{breed.name}</span>
                </a>
              ))
            }
          </div>
          
          <Button href={section.showMore} variant="outline" size="sm" fullWidth={true}>
            Ver todas
          </Button>
        </Card>
      ))}
    </div>
    
    {/* Listado completo */}
    <div>
      <h2 class="text-2xl font-bold mb-6">Todas las razas de {typeInfo.type === 'dog' ? 'perros' : 'gatos'}</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {breeds.map(breed => (
          <!-- ✅ PROPS INDIVIDUALES EN LUGAR DE SPREAD -->
          <BreedCard 
            id={breed.id}
            name={breed.name}
            image={breed.image}
            size={breed.size}
            energyLevel={breed.energyLevel}
            friendliness={breed.friendliness}
            grooming={breed.grooming}
            training={breed.training}
            type={breed.type}
            goodWith={breed.goodWith}
            hypoallergenic={breed.hypoallergenic}
            featured={breed.featured}
          />
        ))}
      </div>
    </div>
    
    {/* Sección de comparador */}
    <div class="mt-16 bg-gray-50 rounded-lg p-8">
      <div class="text-center max-w-3xl mx-auto">
        <h2 class="text-2xl font-bold mb-4">¿No estás seguro de qué raza elegir?</h2>
        <p class="text-lg text-gray-600 mb-6">
          Utiliza nuestro comparador para encontrar la raza de {typeInfo.type === 'dog' ? 'perro' : 'gato'} 
          que mejor se adapte a tu estilo de vida y necesidades.
        </p>
        <Button href="/comparador-razas" variant="primary" size="lg">
          Ir al comparador de razas
        </Button>
      </div>
    </div>
  </Container>
</BaseLayout>