---
// src/pages/articulos/[slug].astro - VERSIÃ“N COMPATIBLE CON TU TAGS.TS
import { getCollection, type CollectionEntry } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { generateTagSlug } from '../../utils/tags.ts';


type ArticuloEntry = CollectionEntry<'articulos'>;

export const prerender = true;

export async function getStaticPaths() {
  const articulos = await getCollection('articulos');
  
  // Filtrar solo artÃ­culos publicados
  const publishedArticles = articulos.filter((article: ArticuloEntry) => 
    article.data.status === 'published'
  );

  console.log(`ğŸ“° Generando ${publishedArticles.length} artÃ­culos para Balto`);
  
  return publishedArticles.map((articulo: ArticuloEntry) => {
    // ğŸ”§ VALIDACIÃ“N SIMPLE USANDO TU FUNCIÃ“N EXISTENTE
    if (import.meta.env.DEV) {
      // Solo en desarrollo, verificar que el slug sea vÃ¡lido
      if (!articulo.slug || articulo.slug.length < 3) {
        console.warn(`âš ï¸ Slug problemÃ¡tico: ${articulo.slug}`);
        // Sugerir slug usando tu funciÃ³n existente
        const suggestedSlug = generateTagSlug(articulo.data.title);
        console.log(`ğŸ’¡ Slug sugerido: ${suggestedSlug}`);
      }
    }

    return {
      params: { slug: articulo.slug },
      props: { articulo }
    };
  });
}

const { articulo } = Astro.props;

if (!articulo) {
  return Astro.redirect('/404');
}

const { Content } = await articulo.render();

function getAuthorAvatar(authorName: string): string {
  // Normalizar el nombre removiendo acentos y espacios extra
  const normalizedName = authorName?.trim().toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, ''); // Remueve acentos
  
  const authorAvatars: Record<string, string> = {
    // Versiones con acentos
    'Ana MarÃ­a Prieto': '/images/ana-p2.webp',
    'Manuel Alejandro Bedoya': '/images/manuel-p1.webp',
    'Equipo Editorial Balto': '/images/baltologo.svg',
    
  };
  
  // Primero intentar con el nombre original
  if (authorAvatars[authorName]) {
    console.log(`âœ… Avatar encontrado para: "${authorName}"`);
    return authorAvatars[authorName];
  }
  
  // Luego intentar con el nombre normalizado
  if (authorAvatars[normalizedName]) {
    console.log(`âœ… Avatar encontrado (normalizado) para: "${authorName}" â†’ "${normalizedName}"`);
    return authorAvatars[normalizedName];
  }
  
  // Debug: mostrar quÃ© nombre estÃ¡ llegando
  console.log(`âŒ No se encontrÃ³ avatar para: "${authorName}" (normalizado: "${normalizedName}")`);
  console.log('ğŸ“ Nombres disponibles:', Object.keys(authorAvatars));
  
  return '/images/authors/default.jpg';
}


// ğŸ”¥ CARGAR ARTÃCULOS REALES DEL CMS PARA EL SIDEBAR - CON TIPOS CORRECTOS
let allArticles: ArticuloEntry[] = [];
try {
  allArticles = await getCollection('articulos');
  allArticles = allArticles.filter((art: ArticuloEntry) => art.data.status === 'published');
} catch (error) {
  console.log('â„¹ï¸ No se pudieron cargar artÃ­culos para sidebar');
  allArticles = [];
}

// ğŸ“ˆ GENERAR ARTÃCULOS POPULARES REALES (ordenados por fecha)
const popularArticles = allArticles
  .filter((art: ArticuloEntry) => art.slug !== articulo.slug)
  .sort((a: ArticuloEntry, b: ArticuloEntry) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5)
  .map((art: ArticuloEntry) => ({
    title: art.data.title,
    slug: art.slug,
    readingTime: art.data.readingTime || 5,
    category: art.data.category || 'General'
  }));

// ğŸ“° GENERAR ARTÃCULOS RELACIONADOS (misma categorÃ­a)
const relatedArticles = allArticles
  .filter((art: ArticuloEntry) => 
    art.slug !== articulo.slug && 
    art.data.category === articulo.data.category
  )
  .slice(0, 3)
  .map((art: ArticuloEntry) => ({
    id: art.slug,
    title: art.data.title,
    image: art.data.image || '/images/articles/default.jpg',
    readingTime: art.data.readingTime || 5
  }));

// ğŸ¯ GENERAR BREADCRUMBS DINÃMICOS PARA BALTO
const breadcrumbItems = [
  { label: 'Inicio', href: '/', icon: 'ğŸ ' },
  { label: 'ArtÃ­culos', href: '/articulos', icon: 'ğŸ“°' }
];

// Agregar categorÃ­a si existe
if (articulo.data.category) {
  breadcrumbItems.push({
    label: articulo.data.category.charAt(0).toUpperCase() + articulo.data.category.slice(1),
    href: `/categorias/${articulo.data.category}`,
    icon: 'ğŸ“‚'
  });
}

// Preparar datos para TU LAYOUT ORIGINAL con todos los estilos
const articleData = {
  title: articulo.data.title,
  description: articulo.data.description,
  author: {
    name: articulo.data.author,
    avatar: getAuthorAvatar(articulo.data.author || 'Editor Balto'), // â† CAMBIO AQUÃ
    bio: articulo.data.authorBio || 'Especialista en cuidado y bienestar de mascotas'
  },
  date: articulo.data.date.toISOString(),
  readingTime: articulo.data.readingTime || 5,
  categories: articulo.data.tags || [articulo.data.category],
  image: articulo.data.image,
  views: articulo.data.views || 0,
  showTableOfContents: true,
  popularArticles: popularArticles,
  relatedArticles: relatedArticles
};

// ğŸ¯ LOG PARA DEBUGGING (solo en desarrollo)
if (import.meta.env.DEV) {
  console.log(`ğŸ¯ Renderizando artÃ­culo: ${articulo.data.title}`);
  console.log(`ğŸ“Š ArtÃ­culos relacionados: ${relatedArticles.length}`);
  console.log(`ğŸ”¥ ArtÃ­culos populares: ${popularArticles.length}`);
}
---

<ArticleLayout {...articleData}>
  <Content />
</ArticleLayout>