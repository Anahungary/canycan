---
// src/pages/articulos/[slug].astro - CORREGIDO PARA USAR ART√çCULOS REALES
import { getCollection } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';

export async function getStaticPaths() {
  const articulos = await getCollection('articulos');
  
  return articulos.map((articulo) => ({
    params: { slug: articulo.slug },
    props: { articulo }
  }));
}

const { articulo } = Astro.props;
const { Content, headings } = await articulo.render();

// üî• CARGAR ART√çCULOS REALES DEL CMS PARA EL SIDEBAR
let allArticles: any[] = [];
try {
  allArticles = await getCollection('articulos');
  // Filtrar solo art√≠culos publicados
  allArticles = allArticles.filter((art: any) => art.data.status === 'published');
} catch (error) {
  console.log('Error cargando art√≠culos para sidebar:', error);
}

// üìà GENERAR ART√çCULOS POPULARES REALES (ordenados por fecha)
const popularArticles = allArticles
  .filter((art: any) => art.slug !== articulo.slug) // Excluir art√≠culo actual
  .sort((a: any, b: any) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5)
  .map((art: any) => ({
    title: art.data.title,
    slug: art.slug,
    readingTime: art.data.readingTime || 5,
    category: art.data.category || 'General'
  }));

// üì∞ GENERAR ART√çCULOS RELACIONADOS (misma categor√≠a)
const relatedArticles = allArticles
  .filter((art: any) => 
    art.slug !== articulo.slug && 
    art.data.category === articulo.data.category
  )
  .slice(0, 3)
  .map((art: any) => ({
    id: art.slug,
    title: art.data.title,
    image: art.data.image || '/images/articles/default.jpg',
    readingTime: art.data.readingTime || 5
  }));

// Preparar datos para el layout con valores por defecto
const articleData = {
  title: articulo.data.title,
  description: articulo.data.description,
  author: {
    name: articulo.data.author || 'Editor PataDigital',
    avatar: '/images/authors/default.jpg',
    bio: articulo.data.authorBio || 'Especialista en cuidado y bienestar de mascotas'
  },
  date: articulo.data.date.toISOString(),
  readingTime: articulo.data.readingTime || 5,
  categories: articulo.data.tags || [articulo.data.category || 'General'],
  image: articulo.data.image || '/images/articles/default.jpg',
  views: 0,
  showTableOfContents: true,
  popularArticles: popularArticles, // üéØ USAR ART√çCULOS REALES
  relatedArticles: relatedArticles   // üéØ USAR ART√çCULOS RELACIONADOS REALES
};
---

<ArticleLayout {...articleData}>
  <Content />
</ArticleLayout>