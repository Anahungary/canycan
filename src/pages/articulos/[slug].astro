---
// src/pages/articulos/[slug].astro - COMPLETAMENTE DINÃMICO DESDE CMS
import { getCollection, type CollectionEntry } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { ArticlesDB } from '../../lib/supabase.js';

// ğŸ”§ TIPOS TYPESCRIPT
type ArticuloEntry = CollectionEntry<'articulos'>;

interface PopularArticle {
  title: string;
  slug: string;
  readingTime: number;
  category: string;
  views: number;
}

interface RelatedArticle {
  id: string;
  title: string;
  image: string;
  readingTime: number;
  views: number;
  slug: string;
}

export const prerender = true;

export async function getStaticPaths() {
  console.log('ğŸš€ INICIANDO getStaticPaths() - Carga dinÃ¡mica desde CMS');
  
  // ğŸ“° CARGAR TODOS LOS ARTÃCULOS DINÃMICAMENTE DESDE EL CMS
  const articulos = await getCollection('articulos');
  const publishedArticles = articulos.filter((article: ArticuloEntry) => 
    article.data.status === 'published'
  );

  console.log(`ğŸ“° ENCONTRADOS: ${publishedArticles.length} artÃ­culos publicados en CMS`);

  // ğŸ”„ SINCRONIZACIÃ“N AUTOMÃTICA - TODOS LOS ARTÃCULOS DEL CMS â†’ SUPABASE
  console.log('ğŸ”„ SINCRONIZANDO automÃ¡ticamente TODOS los artÃ­culos del CMS...');
  
  let syncedCount = 0;
  for (const article of publishedArticles) {
    try {
      const success = await ArticlesDB.syncArticleFromCMS({
        slug: article.slug,
        title: article.data.title,
        category: article.data.category || 'general',
        author: article.data.author || 'Editor Balto',
        readingTime: article.data.readingTime || 5,
        image: article.data.image || '/images/articles/default.jpg'
      });
      
      if (success) {
        syncedCount++;
        console.log(`âœ… Sincronizado: ${article.slug}`);
      } else {
        console.log(`âŒ Error sincronizando: ${article.slug}`);
      }
    } catch (error) {
      console.error(`âŒ Error sincronizando ${article.slug}:`, error);
    }
  }
  
  console.log(`ğŸ¯ SINCRONIZACIÃ“N COMPLETADA: ${syncedCount}/${publishedArticles.length} artÃ­culos`);
  
  return publishedArticles.map((articulo: ArticuloEntry) => ({
    params: { slug: articulo.slug },
    props: { articulo }
  }));
}

interface Props {
  articulo: ArticuloEntry;
}

const { articulo } = Astro.props;

if (!articulo) {
  return Astro.redirect('/404');
}

const { Content } = await articulo.render();

// ğŸ“Š FUNCIÃ“N PARA OBTENER VIEWS REALES DE SUPABASE
async function getSupabaseViews(slug: string): Promise<number> {
  try {
    const stats = await ArticlesDB.getArticleStats(slug);
    const views = stats?.views || 0;
    console.log(`ğŸ“Š Views ${slug}: ${views}`);
    return views;
  } catch (error) {
    console.log(`ğŸ“ŠâŒ Error obteniendo views para ${slug}:`, error);
    return 0;
  }
}

// ğŸ”§ FUNCIÃ“N PARA AVATAR DEL AUTOR
function getAuthorAvatar(authorName: string): string {
  const authorAvatars: Record<string, string> = {
    'Ana MarÃ­a Prieto': '/images/ana-p2.webp',
    'Manuel Alejandro Bedoya': '/images/manuel-p1.webp',
    'Equipo Editorial Balto': '/images/baltologo.svg',
  };
  
  return authorAvatars[authorName] || authorAvatars['Equipo Editorial Balto'];
}

// ğŸ“Š OBTENER VIEWS DEL ARTÃCULO ACTUAL
const articleViews = await getSupabaseViews(articulo.slug);

// ğŸ”¥ OBTENER ARTÃCULOS POPULARES - SOLO DESDE SUPABASE (SIN FALLBACKS)
console.log('ğŸ”¥ Obteniendo artÃ­culos populares desde Supabase...');
const popularArticlesRaw = await ArticlesDB.getPopularArticles(5);
const popularArticles: PopularArticle[] = (popularArticlesRaw || [])
  .filter((article: any) => article.slug !== articulo.slug) // Excluir artÃ­culo actual
  .slice(0, 3)
  .map((article: any) => ({
    title: article.title,
    slug: article.slug,
    readingTime: article.reading_time || 5,
    category: article.category || 'general',
    views: article.views || 0
  }));

console.log(`ğŸ”¥ POPULARES OBTENIDOS: ${popularArticles.length} desde Supabase`);

// ğŸ”— OBTENER ARTÃCULOS RELACIONADOS - SOLO DESDE SUPABASE (SIN FALLBACKS)
console.log(`ğŸ”— Obteniendo relacionados para categorÃ­a: ${articulo.data.category}`);
const relatedArticlesRaw = await ArticlesDB.getArticlesByCategory(
  articulo.data.category || 'general', 
  5
);
const relatedArticles: RelatedArticle[] = (relatedArticlesRaw || [])
  .filter((article: any) => article.slug !== articulo.slug) // Excluir artÃ­culo actual
  .slice(0, 2)
  .map((article: any, index: number) => ({
    id: (index + 1).toString(),
    title: article.title,
    slug: article.slug,
    image: article.image || '/images/articles/default.jpg',
    readingTime: article.reading_time || 5,
    views: article.views || 0
  }));

console.log(`ğŸ”— RELACIONADOS OBTENIDOS: ${relatedArticles.length} desde Supabase`);

// ğŸ“‹ PREPARAR DATOS PARA EL LAYOUT
const articleData = {
  title: articulo.data.title,
  description: articulo.data.description,
  author: {
    name: articulo.data.author || 'Editor Balto',
    bio: articulo.data.author === 'Ana MarÃ­a Prieto' 
      ? 'Especialista en cuidado y bienestar de mascotas'
      : articulo.data.author === 'Manuel Alejandro Bedoya'
      ? 'Entrenador certificado en comportamiento canino'  
      : 'Especialista en cuidado y bienestar de mascotas',
    avatar: getAuthorAvatar(articulo.data.author || 'Editor Balto')
  },
  date: articulo.data.date.toISOString(),
  readingTime: articulo.data.readingTime || 5,
  categories: articulo.data.tags || [articulo.data.category].filter(Boolean),
  category: articulo.data.category,
  image: articulo.data.image,
  views: articleViews,
  popularArticles: popularArticles,
  relatedArticles: relatedArticles
} as const;

// ğŸ¯ LOGS FINALES
console.log(`ğŸ“° ARTÃCULO: ${articulo.data.title}`);
console.log(`ğŸ“Š VIEWS: ${articleViews}`);
console.log(`ğŸ”¥ POPULARES: ${popularArticles.length} (${popularArticles.map(a => `${a.title}:${a.views}`).join(', ')})`);
console.log(`ğŸ”— RELACIONADOS: ${relatedArticles.length} (${relatedArticles.map(a => `${a.title}:${a.views}`).join(', ')})`);
---

<ArticleLayout 
  title={articleData.title}
  description={articleData.description}
  author={articleData.author}
  date={articleData.date}
  readingTime={articleData.readingTime}
  categories={articleData.categories}
  category={articleData.category}
  image={articleData.image}
  views={articleData.views}
  popularArticles={articleData.popularArticles}
  relatedArticles={articleData.relatedArticles}
>
  <Content />
</ArticleLayout>

<!-- ğŸ“Š TRACKING DE VISTAS -->
<script define:vars={{ slug: articulo.slug }}>
  console.log('ğŸ“Š Tracking iniciado para:', slug);
  
  setTimeout(() => {
    if (!sessionStorage.getItem(`viewed_${slug}`)) {
      sessionStorage.setItem(`viewed_${slug}`, 'true');
      
      fetch('/.netlify/functions/article-view', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug })
      }).then(response => response.json())
      .then(data => {
        console.log('ğŸ“Šâœ… Vista registrada:', data);
      }).catch(error => {
        console.log('ğŸ“ŠâŒ Error tracking:', error);
      });
    }
  }, 3000);
</script>