---
// src/pages/articulos/[slug].astro - SIN ERRORES TYPESCRIPT
import { getCollection, type CollectionEntry } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';

type ArticuloEntry = CollectionEntry<'articulos'>;

export const prerender = true;

export async function getStaticPaths() {
  const articulos = await getCollection('articulos');
  
  // Filtrar solo artículos publicados
  const publishedArticles = articulos.filter(article => 
    article.data.status === 'published'
  );
  
  return publishedArticles.map((articulo) => ({
    params: { slug: articulo.slug },
    props: { articulo }
  }));
}

const { articulo } = Astro.props;

if (!articulo) {
  return Astro.redirect('/404');
}

const { Content } = await articulo.render();

// 🔥 CARGAR ARTÍCULOS REALES DEL CMS PARA EL SIDEBAR - CON TIPOS CORRECTOS
let allArticles: ArticuloEntry[] = [];
try {
  allArticles = await getCollection('articulos');
  allArticles = allArticles.filter((art: ArticuloEntry) => art.data.status === 'published');
} catch (error) {
  console.log('ℹ️ No se pudieron cargar artículos para sidebar');
  allArticles = [];
}

// 📈 GENERAR ARTÍCULOS POPULARES REALES (ordenados por fecha)
const popularArticles = allArticles
  .filter((art: ArticuloEntry) => art.slug !== articulo.slug)
  .sort((a: ArticuloEntry, b: ArticuloEntry) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5)
  .map((art: ArticuloEntry) => ({
    title: art.data.title,
    slug: art.slug,
    readingTime: art.data.readingTime || 5,
    category: art.data.category || 'General'
  }));

// 📰 GENERAR ARTÍCULOS RELACIONADOS (misma categoría)
const relatedArticles = allArticles
  .filter((art: ArticuloEntry) => 
    art.slug !== articulo.slug && 
    art.data.category === articulo.data.category
  )
  .slice(0, 3)
  .map((art: ArticuloEntry) => ({
    id: art.slug,
    title: art.data.title,
    image: art.data.image || '/images/articles/default.jpg',
    readingTime: art.data.readingTime || 5
  }));

// Preparar datos para TU LAYOUT ORIGINAL con todos los estilos
const articleData = {
  title: articulo.data.title,
  description: articulo.data.description,
  author: {
    name: articulo.data.author,
    avatar: '/images/authors/default.jpg',
    bio: articulo.data.authorBio || 'Especialista en cuidado y bienestar de mascotas'
  },
  date: articulo.data.date.toISOString(),
  readingTime: articulo.data.readingTime || 5,
  categories: articulo.data.tags || [articulo.data.category],
  image: articulo.data.image,
  views: articulo.data.views || 0,
  showTableOfContents: true,
  popularArticles: popularArticles,
  relatedArticles: relatedArticles
};
---

<ArticleLayout {...articleData}>
  <Content />
</ArticleLayout>